# 日志存储与审计

本模块为 NasProxy 提供统一的访问日志与审计能力，满足高可靠采集、结构化入库、易查询与可视化展示的要求；基于 Syslog（RFC5424）传输，接收端落地到 MySQL 并支持批量写入与留存归档。

---

## 1. 总体架构

- 发送端（Proxy Core）
  - 日志标准化：将 HTTP/SOCKS5/SS 访问记录转换为统一结构
  - 内存队列缓冲：高水位限流，低水位恢复（避免丢包/阻塞转发）
  - 异步发送：Syslog over TCP（可选 TLS），批量聚合、失败重试、磁盘回退
- 传输协议
  - Syslog RFC5424 格式，TCP 传输（默认）；支持 TLS（推荐生产启用）
  - 字段放入 Structured Data（SDID）或消息体 JSON
- 接收端（Management）
  - Syslog Receiver：持续监听 TCP/TLS 端口，处理连接与半包
  - Parser & Normalizer：解析 RFC5424，映射内部统一字段
  - Batch Writer：按批大小/时间窗落库 MySQL（事务 + 预编译语句）
  - Backpressure：数据库压力过高时，接收端降速/丢弃低优先级
- 存储与查询
  - MySQL InnoDB 表，索引按时间/主查询维度设计
  - 提供常用 TopN/趋势/错误占比/延迟分位查询 SQL
- 审计
  - 覆盖管理面关键操作，采用哈希链防篡改（应用层实现），SQL 查询驱动展示

---

## 2. 数据模型（MySQL）

建议库字符集 utf8mb4、行格式 DYNAMIC；按需进行分区（按天/月）。

- 表：proxy_access_log（访问日志）
```sql
CREATE TABLE IF NOT EXISTS proxy_access_log (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  ts_ms BIGINT NOT NULL COMMENT '毫秒时间戳',
  request_id VARCHAR(64) NULL,
  client_ip VARCHAR(64) NULL,
  user_id VARCHAR(64) NULL,
  protocol ENUM('http','socks5','ss') NOT NULL,
  method VARCHAR(16) NULL,
  host VARCHAR(255) NULL,
  path VARCHAR(1024) NULL,
  sni VARCHAR(255) NULL,
  target VARCHAR(255) NULL,
  status INT NULL,
  bytes_in BIGINT UNSIGNED DEFAULT 0,
  bytes_out BIGINT UNSIGNED DEFAULT 0,
  latency_ms INT UNSIGNED NULL,
  upstream VARCHAR(128) NULL,
  sniff_proto VARCHAR(32) NULL,
  error_code VARCHAR(64) NULL,
  error_msg VARCHAR(512) NULL,
  extra JSON NULL,
  PRIMARY KEY (id),
  KEY idx_ts (ts_ms),
  KEY idx_host_ts (host, ts_ms),
  KEY idx_status_ts (status, ts_ms),
  KEY idx_user (user_id),
  KEY idx_sniff (sniff_proto),
  UNIQUE KEY uk_req (request_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

- 表：audit_trail（审计日志，追加写）
```sql
CREATE TABLE IF NOT EXISTS audit_trail (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  ts_ms BIGINT NOT NULL,
  actor VARCHAR(128) NOT NULL,
  action VARCHAR(128) NOT NULL,
  resource VARCHAR(128) NOT NULL,
  resource_id VARCHAR(128) NULL,
  result ENUM('success','fail') NOT NULL,
  ip VARCHAR(64) NULL,
  user_agent VARCHAR(255) NULL,
  before_json JSON NULL,
  after_json JSON NULL,
  prev_hash CHAR(64) NOT NULL,
  hash CHAR(64) NOT NULL,
  anchor_sig VARCHAR(255) NULL,
  PRIMARY KEY (id),
  KEY idx_ts (ts_ms),
  KEY idx_actor (actor),
  KEY idx_action (action),
  KEY idx_resource (resource, resource_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

可选指标与主机健康（如需接入看板）：
- host_metrics(host_id, cpu_percent, mem_used_mb, ...)
- smart_metrics(host_id, disk_id, temperature_c, wearout_percent, ...)

---

## 3. Syslog 报文规范与映射

- 采用 RFC5424：<PRI>VERSION TIMESTAMP HOST APP PROCID MSGID [SD] MSG
- 建议字段映射：
  - APP：nasproxy-core
  - MSGID：access_log 或 audit
  - SD：`[np@1 request_id="..." protocol="http" method="CONNECT" host="example.com" status="200" latency_ms="85" bytes_in="1024" bytes_out="2048" upstream="direct" sniff_proto="https"]`
  - MSG：当字段过多或复杂时，使用 JSON 体承载：`{"target":"93.184.216.34:443","path":null,"sni":"example.com"}`
- 发送端需保证：
  - 单条日志大小上限（建议 8–32 KB）
  - UTF-8 编码；敏感字段脱敏（Authorization/Token/Cookie 等）

---

## 4. 发送端（Proxy Core）实现要点

- 内存队列：
  - 环形缓冲 + 批量聚合；阈值：batch_size=500，flush_interval=1s（可配）
  - 高水位（如 100k 条）触发降速；溢出写本地滚动文件（回退队列）
- 连接与重试：
  - Syslog TCP 长连接，异常时指数退避（500ms, 1s, 2s, 5s, 10s ...）
  - 按批发送；失败批次落盘并排队重投
- TLS：
  - 可选启用 mTLS 或至少校验服务端证书
- 可观测性：
  - 暴露发送成功/失败、队列长度、重试次数等指标

---

## 5. 接收端（Management）实现要点

- 网络层：
  - 粘包拆包、半包处理；连接数限制与超时
- 解析与标准化：
  - 解析 RFC5424 头、SD、MSG；合并为内部统一对象
  - 字段校验与截断：error_msg、path 等设置最大长度
- 批量写入 MySQL：
  - 预编译 INSERT 语句，500–1000 条/批；事务提交
  - 对 request_id 建立唯一键，可自然去重
  - 捕获主键/唯一键冲突，忽略重复
- 背压：
  - DB 写入延迟过高时，降低接收速率或临时拒绝（连接限流）

---

## 6. 脱敏与安全

- 发送端脱敏：
  - Authorization/Cookie/Set-Cookie/密码/密钥：只保留前后若干字符，中间以 **** 替换
- 传输安全：
  - 推荐启用 TLS；接收端仅开放内网或受控端口
- 访问控制：
  - 接收端支持 IP 白名单；管理 API 需鉴权

---

## 7. 常用查询 SQL（示例）

- 7.1 近 24 小时流量趋势（每 5 分钟）
```sql
SELECT FROM_UNIXTIME(ts_ms/1000 - (ts_ms/1000)%300) AS ts5m,
       COUNT(*) AS req,
       SUM(bytes_in) AS bin,
       SUM(bytes_out) AS bout
FROM proxy_access_log
WHERE ts_ms >= UNIX_TIMESTAMP(NOW() - INTERVAL 24 HOUR)*1000
GROUP BY ts5m
ORDER BY ts5m;
```

- 7.2 Host 访问 TopN（近 1 天按请求数）
```sql
SELECT host, COUNT(*) AS cnt
FROM proxy_access_log
WHERE ts_ms >= UNIX_TIMESTAMP(NOW() - INTERVAL 1 DAY)*1000
  AND host IS NOT NULL AND host <> ''
GROUP BY host
ORDER BY cnt DESC
LIMIT 10;
```

- 7.3 错误占比（5xx/总数）
```sql
SELECT SUM(CASE WHEN status >= 500 THEN 1 ELSE 0 END)/COUNT(*) AS ratio
FROM proxy_access_log
WHERE ts_ms >= UNIX_TIMESTAMP(NOW() - INTERVAL 1 HOUR)*1000;
```

- 7.4 延迟分位（近 1 小时）
```sql
SELECT PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY latency_ms) AS p50,
       PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY latency_ms) AS p95,
       PERCENTILE_CONT(0.99) WITHIN GROUP (ORDER BY latency_ms) AS p99
FROM proxy_access_log
WHERE ts_ms >= UNIX_TIMESTAMP(NOW() - INTERVAL 1 HOUR)*1000
  AND latency_ms IS NOT NULL;
```
注：若 MySQL 版本不支持 PERCENTILE_CONT，可用近似方法：按桶聚合或使用窗口函数计算近似分位。

- 7.5 上游出站效果对比（失败率/平均延迟）
```sql
SELECT upstream,
       SUM(CASE WHEN status >= 500 THEN 1 ELSE 0 END)/COUNT(*) AS err_ratio,
       AVG(latency_ms) AS avg_latency
FROM proxy_access_log
WHERE ts_ms >= UNIX_TIMESTAMP(NOW() - INTERVAL 6 HOUR)*1000
GROUP BY upstream
ORDER BY err_ratio DESC, avg_latency DESC;
```

---

## 8. 审计模块 SQL 展示（示例）

- 8.1 最近 100 条关键操作
```sql
SELECT FROM_UNIXTIME(ts_ms/1000) AS ts, actor, action, resource, resource_id, result
FROM audit_trail
ORDER BY id DESC
LIMIT 100;
```

- 8.2 指定资源变更历史
```sql
SELECT FROM_UNIXTIME(ts_ms/1000) AS ts, actor, action, result, before_json, after_json
FROM audit_trail
WHERE resource = 'route_rule' AND resource_id = ?
ORDER BY id DESC;
```

- 8.3 哈希链连续性校验（应用层建议实现）
  - 规则：`hash = SHA256(CONCAT(ts_ms,'|',actor,'|',action,'|',COALESCE(JSON_EXTRACT(before_json,'$'),''),'|',COALESCE(JSON_EXTRACT(after_json,'$'),''),'|',prev_hash))`
  - SQL 校验思路：取按 id 排序的数据，在应用层逐行重算并对比 `prev_hash`/`hash`；也可在 MySQL 中通过变量行走检查：
```sql
SET @ok := 1; SET @prev := '';
SELECT id,
       IF(prev_hash = @prev OR @prev = '', @ok:=@ok, @ok:=0) AS chain_ok,
       @prev := hash AS prev_update
FROM audit_trail
ORDER BY id;
-- 最终 @ok=1 表示链完整
```

- 8.4 操作人 TopN
```sql
SELECT actor, COUNT(*) AS cnt
FROM audit_trail
WHERE ts_ms >= UNIX_TIMESTAMP(NOW() - INTERVAL 7 DAY)*1000
GROUP BY actor
ORDER BY cnt DESC
LIMIT 10;
```

---

## 9. 留存与分区/归档

- 保留策略：
  - 访问日志：7–30 天热数据；更久的数据归档到冷存（例如按天分表/分区或导出对象存储）
  - 审计日志：180–365 天
- MySQL 分区建议（示例：按月 RANGE）：
```sql
ALTER TABLE proxy_access_log
PARTITION BY RANGE (TO_DAYS(FROM_UNIXTIME(ts_ms/1000))) (
  PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
  PARTITION pmax VALUES LESS THAN MAXVALUE
);
```
- 清理策略：
  - 定期删除过期分区或批量删除过期数据并 OPTIMIZE TABLE

---

## 10. 性能与参数建议

- 批量写入：500–1000/批；单批事务大小控制在 1–2 MB 以内
- 索引：优先 ts_ms、(host, ts_ms)、(status, ts_ms)、user_id
- 表设置：ROW_FORMAT=DYNAMIC，innodb_flush_log_at_trx_commit=1（强一致）或 2（更高吞吐）
- 连接池：接收端使用连接池与预编译语句缓存
- 压测：模拟 1–5 万 qps 入库，观察 TPS、95/99 延迟与失败率

---

## 11. 部署与配置（示例）

- 接收端配置项：
  - syslog.listen_addr: 0.0.0.0:1514
  - syslog.tls.enabled: true/false，cert/key 路径
  - batch.size: 500；batch.flush_interval_ms: 1000
  - mysql.dsn: user:pass@tcp(host:3306)/db?parseTime=true&charset=utf8mb4
  - limits.max_connections、limits.max_queue_size
- 发送端配置项：
  - syslog.server: host:1514（支持多地址容灾）
  - queue.max_in_memory、queue.fallback_path
  - retry.backoff、tls 校验策略

---

## 12. 风险与对策

- 瞬时峰值导致写入堆积：队列限流 + 批量 + 回退落盘 + 接收端背压
- 单点 MySQL 压力：主从读写分离或迁移到列存/日志型引擎（后续演进）
- 审计链密钥：服务私钥妥善保管，锚定签名离线备份

---

以上设计覆盖采集、传输、存储与查询的闭环，发送端/接收端均可循序实现，优先打通基础链路与常用查询/可视化。