# 管理员登录会话模块设计（Spring Boot Web + Security + JWT 实现）

[toc]

## 1. 接口设计（REST）

所有接口除登录外均要求 Header 携带 `Authorization: Bearer <jwt>`。

- POST /admin/login
  - 请求：{ username: string(1-64), password: string(8-64) }
  - 响应：{ token: string, mustChangePassword: boolean, expiresIn: number(seconds), user: { id, username, roles } }
  - 状态码：200 成功；401 密码错误或用户禁用；429 过多尝试；500 服务器错误

- POST /admin/logout（可选启用黑名单）
  - 请求：无；Header 必需 Bearer token
  - 响应：{ ok: true }
  - 状态码：200 成功；401 未认证

- POST /admin/change-password
  - 首次登录：请求 { newPassword: string(8-64) }
  - 普通修改：请求 { oldPassword: string(8-64), newPassword: string(8-64) }
  - 响应：{ token: string, mustChangePassword: false }
  - 状态码：200 成功；400 参数不合法；401 未认证；403 首次登录未改密时访问非改密接口；422 旧密码不正确；500 服务器错误

- GET /admin/me
  - 请求：无；Header 必需 Bearer token
  - 响应：{ userId, username, roles: string[], mustChangePassword: boolean }
  - 状态码：200 成功；401 未认证

Header 规范：
- Authorization: Bearer <jwt>
- 可选 X-Request-Id：链路追踪与审计

错误响应统一结构：
- { code: string, message: string, requestId?: string }

## 2. 数据库表设计（MySQL）

admin_user（管理员账号）
- id BIGINT PK AUTO_INCREMENT
- username VARCHAR(64) UNIQUE NOT NULL
- password_hash VARCHAR(255) NOT NULL
- roles VARCHAR(255) NOT NULL（JSON/逗号分隔，例如 "ADMIN"）
- must_change_password TINYINT(1) NOT NULL DEFAULT 1
- ver INT NOT NULL DEFAULT 1（密钥版本；改密或禁用时递增）
- status TINYINT NOT NULL DEFAULT 1（1=启用，0=禁用）
- created_at DATETIME NOT NULL
- updated_at DATETIME NOT NULL
索引：UNIQUE(username)，INDEX(status)，INDEX(updated_at)

DDL 示例：

```sql
CREATE TABLE admin_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(64) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    roles VARCHAR(255) NOT NULL,
    must_change_password TINYINT(1) NOT NULL DEFAULT 1,
    ver INT NOT NULL DEFAULT 1,
    status TINYINT NOT NULL DEFAULT 1,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL
);
```

admin_login_history（登录历史）
- id BIGINT PK AUTO_INCREMENT
- user_id BIGINT NULL（失败时可能为空）
- username VARCHAR(64) NOT NULL
- success TINYINT(1) NOT NULL
- ip VARCHAR(64) NULL
- ua VARCHAR(255) NULL
- reason VARCHAR(128) NULL（失败原因摘要）
- created_at DATETIME NOT NULL
索引：INDEX(user_id, created_at)，INDEX(username, created_at)

DDL 示例：

```sql
CREATE TABLE admin_login_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NULL,
    username VARCHAR(64) NOT NULL,
    success TINYINT(1) NOT NULL,
    ip VARCHAR(64) NULL,
    ua VARCHAR(255) NULL,
    reason VARCHAR(128) NULL,
    created_at DATETIME NOT NULL
);
```



admin_token_blacklist（可选，登出或封禁后黑名单）
- jti VARCHAR(64) PRIMARY KEY
- expires_at DATETIME NOT NULL
索引：PRIMARY(jti)，INDEX(expires_at)

DDL 示例：
- CREATE TABLE admin_token_blacklist (
  jti VARCHAR(64) PRIMARY KEY,
  expires_at DATETIME NOT NULL
);

## 3. JWT 会话设计

- Header 使用：Authorization: Bearer <jwt>
- 可选 Cookie：Admin-Session=<jwt>（HttpOnly, Secure, SameSite=Lax/Strict）
- TTL：30 天固定（不启用刷新 Token）
- Claims：
  - sub：用户 ID
  - name：用户名
  - roles：角色数组（如 ["ADMIN"]）
  - mustChangePassword：布尔，首次登录为 true
  - ver：用户密钥版本（数据库 admin_user.ver）
  - jti：Token 唯一 ID
  - iss：nasproxy-management（可配置）
  - iat/exp：签发/过期时间
- 失效策略：
  - 改密或禁用：ver++ 导致旧 token ver 不匹配被拒绝
  - 登出（可选）：记录 jti 至黑名单，TTL=剩余有效期

## 4. Spring Security 实现要点

- PasswordEncoder：BCryptPasswordEncoder（成本系数 10-12）
- UserDetailsService：按用户名加载 admin_user，封装 roles、mustChangePassword、ver、status
- AuthenticationManager：DaoAuthenticationProvider（BCrypt 验证）
- SecurityFilterChain：
  - 放行：/admin/login
  - 认证：/admin/me、/admin/change-password、/admin/logout 及其它管理接口
  - 会话策略：STATELESS；禁用默认表单登录；CSRF 关闭（使用 Header Token）
  - 异常：401（未认证）、403（禁止访问；含首次登录未改密阻断）
- JwtAuthenticationFilter（OncePerRequestFilter）：
  - 从 Authorization 头解析 token → 校验签名、过期、issuer
  - 加载用户并比对 ver；校验黑名单（可选）
  - mustChangePassword=true 时仅允许 /admin/change-password；其他请求返回 403

## 5. 逻辑流程（精细化）

登录（/admin/login）：
- 输入 username/password → 读取用户（若 status=0 则拒绝）
- BCrypt 校验密码；失败记录 admin_login_history（success=0, reason="bad_credentials"）
- 成功：生成 JWT（含 mustChangePassword、ver、jti）并返回；记录 admin_login_history（success=1）

退出登录（/admin/logout）：
- 解析 jti；若启用黑名单 → 写入 admin_token_blacklist（TTL=剩余有效期）
- 返回 200；客户端删除本地 token/cookie

修改密码（/admin/change-password）：
- 首次登录：仅 newPassword；校验强度；更新 password_hash、must_change_password=false、ver=ver+1 → 签发新 token 返回
- 普通修改：校验 oldPassword 正确；流程同上
- 记录审计：成功/失败、原因

鉴权与阻断：
- 所有受保护接口 → 校验 token、ver、黑名单（可选）
- mustChangePassword=true 且不是 /admin/change-password → 403（code="FORCE_PASSWORD_CHANGE"）

## 6. 配置项（application.yml）

- admin.auth.jwt.secret：JWT 签名密钥（避免明文暴露）
- admin.auth.jwt.ttlDays：30
- admin.auth.jwt.issuer：nasproxy-management
- admin.auth.cookie.enabled：true/false
- admin.auth.cookie.name：Admin-Session
- admin.auth.cookie.domain：可选
- admin.auth.cookie.secure：true
- admin.auth.login.rateLimitPerMinute：5（按 用户名+IP）
- cors.allowed-origins：前端域名白名单

## 7. 校验规则

- 用户名：1-64 字符；字母数字下划线
- 密码：8-64 字符；建议至少包含字母+数字（可加入强度校验）
- newPassword 与 oldPassword 不可相同
- 角色：仅 ADMIN（可扩展）

## 8. 开发结构建议

- control-manager/security/SecurityConfig：PasswordEncoder、AuthenticationManager、SecurityFilterChain
- control-manager/security/JwtService：token 签发/校验、jti 生成
- control-manager/security/JwtAuthenticationFilter：解析校验、ver 比对、首次改密阻断
- control-manager/admin/AdminController：login、logout、change-password、me
- control-manager/repository/AdminUserRepository：JPA/Mapper
- control-manager/service/AdminAuthService：登录/改密/审计
- control-manager/service/RateLimitService（可选）：登录限流（用户名+IP）

## 9. 示例请求（curl）

- 登录：
  - curl -X POST http://localhost:8080/admin/login -H "Content-Type: application/json" -d "{\"username\":\"admin\",\"password\":\"Password123\"}"
- 携带 token 获取我：
  - curl -X GET http://localhost:8080/admin/me -H "Authorization: Bearer <jwt>"
- 首次改密：
  - curl -X POST http://localhost:8080/admin/change-password -H "Authorization: Bearer <jwt>" -H "Content-Type: application/json" -d "{\"newPassword\":\"NewPass123\"}"
- 普通改密：
  - curl -X POST http://localhost:8080/admin/change-password -H "Authorization: Bearer <jwt>" -H "Content-Type: application/json" -d "{\"oldPassword\":\"Password123\",\"newPassword\":\"NewPass123\"}"
- 登出（启用黑名单）：
  - curl -X POST http://localhost:8080/admin/logout -H "Authorization: Bearer <jwt>"

## 10. 错误码示例

- 401 UNAUTHORIZED：{ code: "UNAUTHORIZED", message: "invalid or expired token" }
- 403 FORBIDDEN（首次改密阻断）：{ code: "FORCE_PASSWORD_CHANGE", message: "please change password first" }
- 422 UNPROCESSABLE ENTITY：{ code: "BAD_CREDENTIALS", message: "old password incorrect" }
- 429 TOO MANY REQUESTS：{ code: "RATE_LIMIT", message: "too many login attempts" }

## 11. 测试与验收清单

- 登录成功与失败路径；失败写入历史
- 首次登录访问受保护接口 → 403；访问改密接口 → 200，返回新 token
- 改密后旧 token ver 不匹配 → 401/403 拒绝
- 登出（启用黑名单）后 token 立即失效
- TTL 回归：短时间过期策略验证（临时将 ttlDays 设置成 1 分钟）
- 限流：同一 用户名+IP 过多尝试被 429

以上设计可直接用于代码落地。如果需要，我可以据此一次性实现最小可运行的 Spring Boot 模块、接口与安全链，确保能立即启动与联调。

