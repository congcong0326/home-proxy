# 代理模块设计


很好，我来帮你把“代理模块设计”需要覆盖的方面梳理成一份完整而可落地的提纲，确保与现有三份文档对齐，并与首页说明保持一致性。

参考文件
- <mcfile name="代理模块设计.md" path="c:\Users\caominggui\Desktop\create\docs\代理模块设计.md"></mcfile>
- <mcfile name="README.md" path="c:\Users\caominggui\Desktop\create\README.md"></mcfile>
- <mcfile name="控制面与数据面接口交互.md" path="c:\Users\caominggui\Desktop\create\docs\控制面与数据面接口交互.md"></mcfile>
- <mcfile name="日志存储与审计.md" path="c:\Users\caominggui\Desktop\create\docs\日志存储与审计.md"></mcfile>
- <mcfile name="管理员登陆会话模块.md" path="c:\Users\caominggui\Desktop\create\docs\管理员登陆会话模块.md"></mcfile>
- <mcfolder name="images" path="c:\Users\caominggui\Desktop\create\images\"></mcfolder>

建议的“代理模块设计”文档结构（含每节要点）
1) 概述与目标
- 说明数据面（Proxy Core）的定位与非目标（如不负责管理认证、版本回滚）；
- 目标对齐 README 的“核心能力/性能目标/路线图”，定义 MVP 范围与可选项；
- 与控制面职责边界与接口形态的简述（订阅配置、上报指标/日志）。

2) 架构与线程模型
- 进程内模块图：Netty Server、ProtocolDetector、Session Manager、Router、DNS、Outbound、RateLimiter、Metrics、Syslog Client；
- 线程模型：boss/group eventLoop 数、阻塞/非阻塞边界、阻塞操作（DNS/数据库/文件）的隔离策略；
- 内存与缓冲：Pooled ByteBuf、零拷贝路径、对象池策略、背压控制（isWritable、高低水位）。

3) 协议支持与握手流程
- HTTP/HTTPS CONNECT：显式代理请求/隧道建立、CONNECT 后的转发策略、Proxy-Authorization 解析与脱敏；
- SOCKS5：无认证、用户名/密码认证两种握手分支，错误码映射；
- Shadowsocks（最小子集）：AEAD 算法范围、握手与加密/解密路径、单用户单端口的约束；
- 状态机/时序图建议：首包嗅探、握手、路由、建立上游、转发、回收；
- 超时策略：握手超时、上游连接超时、空闲超时（读/写/全双工）。

4) 单端口协议嗅探与 TLS 处理
- 嗅探矩阵与约束对齐控制面文档：非 TLS 端口支持 SOCKS5 + HTTPS CONNECT 组合；开启 TLS 的端口仅单协议；
- 首字节/首包判定规则、回退与错误处理；
- TLS/STARTTLS 范围、证书使用策略（内置签发器，数据面不管理证书文件，按控制面开关启用/禁用）、mTLS 是否规划。

5) 认证与会话
- 用户凭据使用与范围：SOCKS5 用户名/密码，SS 密码；凭据来源与缓存策略；
- 鉴权失败与限流联动（例如连续失败触发速率限制）；
- 会话生命周期：连接建立、认证、路由决定、数据转发、Idle 清理、审计/日志点位。

6) DNS 与主机解析
- 优先级：hosts（静态映射）→ 缓存 → 系统解析/自建 Resolver；
- 解析策略：A/AAAA 优先、重试、TTL、预热、负载分摊；
- 可选：DoT/DoH（规划项）、EDNS、解析失败的快速回退；
- 与路由的交互：域名规则先行、解析后再应用 IP 规则、失败路径。

7) 智能路由与出站管理
- 与控制面 routes 对齐：domains/ip_cidrs/ports/network 条件 + policy（direct/block/outbound_proxy）+ outbound_tag；
- 负载均衡：weighted round-robin、least-conn、故障摘除与恢复、健康检查；
- 出站类型：direct、上游 socks5、上游 ss（如规划）；连接池与复用策略；
- 故障处理：Circuit-breaker、重试策略、回退出站、超时与熔断参数。

8) 限流与 QoS
- 与控制面 rate_limits 对齐：全局/按用户，令牌桶模型（上/下行 bps、突发）；
- 计量点：解密/解码后、加密/编码前的准确计量；
- 冲突裁决与生效优先级（users > global）、热更新生效策略。

9) 转发与性能路径
- 数据通道：零拷贝可能路径（CompositeByteBuf/FileRegion）、合并/分片策略；
- 背压：读写水位联动、写队列管理、慢上游/慢下游处理；
- TCP 参数：TCP_NODELAY、SO_REUSEADDR、keepalive、缓冲大小的建议；
- UDP（规划项）：SOCKS5 UDP Associate 的支持计划与边界。

10) 运行配置与热更新
- 运行态配置 JSON 结构：由控制面聚合产出，数据面订阅全量覆盖；
- 幂等与版本：version + checksum 校验，相同版本不重载，不一致回退；
- 热更新策略：配置切换的无损/最小损失原则，滚动替换路由表/限流表/用户凭据缓存。

11) 观测性与日志
- 指标：连接数、握手成功率/失败码、请求数、流量、延迟分位、上游故障率/重试次数、限流命中；导出方式（如 Prometheus/自描述 JSON）；
- 日志：接入 <mcfile name="日志存储与审计.md" path="c:\Users\caominggui\Desktop\create\docs\日志存储与审计.md"></mcfile> 的 Syslog 规范，字段映射与脱敏点位，发送端缓冲/重试/回退；
- 诊断：按连接/会话的 trace id；采样策略与开关。

12) 错误码与异常处理
- 协议层错误映射（SOCKS5 reply、HTTP 状态）；本地错误分类（解析、路由、出站、限流、上游失败）；
- 重试/回退规则矩阵（哪些错误可重试/切换出站，哪些直接失败）。

13) 安全与合规
- 明文/密钥处理：仅在内存持有，日志全量脱敏，避免落盘；敏感配置的最小使用原则；
- 防护：连接数/速率限制、恶意探测/爆破检测、资源沙箱；
- 传输：推荐 TLS/mtls 的启用策略与证书校验。

14) 测试与验收
- 功能用例：三协议握手矩阵、组合嗅探、TLS 单协议约束；
- 可靠性：配置热更幂等、失败回退、断网/重连；
- 压测：吞吐、延迟分位、内存/GC、背压与丢弃、上游故障注入；
- 兼容性：常见客户端（curl、浏览器、SS 客户端）、IPv4/IPv6。

15) 性能目标与调优
- 目标与 README 一致；关键参数建议（EventLoop 数、池化、ByteBuf 策略、队列阈值）；
- 调优手段与可观测性指标对应关系。

16) 部署与运维
- 启动参数与环境变量、端口清单、系统限制（ulimit、内核参数建议）；
- 日志/指标/核心转储的路径与旋转策略；
- 故障排查流程（从指标到日志到连接/会话级诊断）。

17) 风险与对策、演进路线
- 单点/内存压力/上游抖动/长连接泄漏等风险与缓解；
- 路线图对齐 README 的 M1–M5，明确本模块的阶段性交付物。

与现有文档的关键对齐点
- 与控制面文档：严格执行协议与端口组合约束、SS 单用户单端口、TLS 开关策略、限流生效范围、路由策略字段含义与优先级；订阅与热更流程保持“覆盖式发布 + 幂等”一致性。参见 <mcfile name="控制面与数据面接口交互.md" path="c:\Users\caominggui\Desktop\create\docs\控制面与数据面接口交互.md"></mcfile>
- 与日志/审计文档：发送端 Syslog RFC5424 的字段映射、批量/回退/重试策略、脱敏点位必须一致。参见 <mcfile name="日志存储与审计.md" path="c:\Users\caominggui\Desktop\create\docs\日志存储与审计.md"></mcfile>
- 与管理员登录会话：该文档属于管理面；在本模块仅需说明“数据面不依赖管理面鉴权运行，配置获取通过管理面接口受 JWT 保护（若采用主动轮询/长连接订阅）”，并明确运行隔离与故障退化策略。参见 <mcfile name="管理员登陆会话模块.md" path="c:\Users\caominggui\Desktop\create\docs\管理员登陆会话模块.md"></mcfile>
- 与 README：保持“核心能力、性能目标、路线图”的用词和指标一致，避免口径偏差。参见 <mcfile name="README.md" path="c:\Users\caominggui\Desktop\create\README.md"></mcfile>

建议补充/更新的配图（SVG）
- 协议嗅探状态机（细化至首字节/首包分支）；
- 三协议握手时序图（HTTP CONNECT、SOCKS5 两分支、SS）；
- 路由决策流程（域名→规则→出站选择→健康检查/负载均衡→连接建立）；
- 数据转发与背压控制链路图；
- 配置热更与幂等生效时序。
你已有多张架构与流程图，可复用并扩展至模块级。目标放在 <mcfolder name="images" path="c:\Users\caominggui\Desktop\create\images\"></mcfolder>。

可立即落地的“编写顺序”建议
- 第一轮（最小可用）：2 架构与线程模型、3 协议支持与握手、4 嗅探与 TLS、7 路由与出站、10 运行配置与热更、11 观测与日志；
- 第二轮（性能与安全）：8 限流与 QoS、9 转发与性能、12 错误码、13 安全与合规、15 性能调优；
- 第三轮（交付与维护）：14 测试与验收、16 运维、17 风险与路线。

如果你愿意，我可以基于上述提纲，直接在“代理模块设计.md”里生成一份结构化的章节骨架，并预填关键小节要点，方便你逐章完善。需要我现在就把骨架写入到该文件吗？
        