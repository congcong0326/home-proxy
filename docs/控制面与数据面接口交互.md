# 控制面与数据面接口交互

[toc]

## 一、能力与约束

- 支持协议：SOCKS5（可选 over TLS）、HTTPS CONNECT（可选 over TLS）、Shadowsocks。
- 端口组合与嗅探：
  - 同一端口允许 SOCKS5 + HTTPS CONNECT 的“非 TLS”组合（协议嗅探识别）。
  - 不支持将 SOCKS5 over TLS 与非 TLS 的 HTTPS CONNECT 混在同一端口（因为一个需要 TLS，一个不需要）。
  - 若启用 TLS 的入站端口，建议只绑定单一协议，避免复杂握手与嗅探歧义。
- 账户与端口策略：
  - Shadowsocks：每个用户一个独立端口（端口隔离）。
  - SOCKS5 与 HTTPS CONNECT：一个端口可服务多个用户（用户名/密码认证）。
- TLS 证书策略：采用“内置签发器”，无需在配置中管理证书与私钥；仅保留 tls_enabled 开关。
- 可以基于每个用户配置不通的限流策略，比如上行下行带宽

## 二、研发设计

### 2.1 数据库表设计（无外键，适度反范式）

- 设计目标：
  - 不使用数据库外键，所有“关联”均以字符串 ID 弱引用的方式保存。
  - 表设计保持简单，避免过度三范式；允许在单表中以 JSON/TEXT 存放列表或结构化信息。
  - Shadowsocks 用户与其他 SOCKS5/HTTPS CONNECT 入站用户统一存放在同一张用户表中，不做物理区分。

- 表：users（统一的用户表）
  - id（string，UUID）
  - username（string，唯一）
  - credential（string，可空；socks_basic 与 ss 共用，分别代表登录密码或 ss 口令）
  - status（enum：enabled｜disabled，默认 enabled）
  - remark（string，可空）
  - created_at（timestamp）
  - updated_at（timestamp）
  - 说明：
    - Shadowsocks 与 SOCKS5/HTTPS CONNECT 的用户均在此表；通过 auth_type 区分能力，但整体不区别对待。
    - 当前不强制对 credential 进行加密存储，可明文保存；后续可按需替换为加密/哈希方案。
  
- 表：inbound_configs（入站配置）
  - id（string，UUID）
  - name（string）
  - protocol（enum：socks5｜https_connect｜socks5_https｜ss）
  - listen_ip（string，默认 0.0.0.0）
  - port（int）
  - tls_enabled（bool，默认 false）
  - sniff_enabled（bool，默认 false，仅在 protocol=socks5_https 且非 TLS 时有效）
  - ss_method（string，可空；仅 protocol=ss 使用，如 aes-256-gcm/chacha20-ietf-poly1305 等）
  - allowed_user_ids（JSON，存放用户 ID 的数组，如 ["u1","u2"]）
  - route_id（string，可空；弱引用 routes.id）
  - status（enum：enabled｜disabled，默认 enabled）
  - notes（string，可空）
  - created_at（timestamp）
  - updated_at（timestamp）
  - 业务约束：
    - protocol=socks5_https 仅在 tls_enabled=false 时允许，用于同端口嗅探 SOCKS5 与 HTTPS CONNECT。
    - protocol=ss 时必须且仅允许绑定 1 个用户（allowed_user_ids 长度=1），且该端口不可与任何其他入站复用。
    - 启用 TLS 的入站建议只绑定单一协议（即 protocol 不是 socks5_https）。

- 表：routes（路由规则）
  - id（string，UUID）
  - name（string）
  - rules_json（JSON，示例：{"domains":["*.example.com"],"ip_cidrs":["10.0.0.0/8"],"ports":"80,443","network":"tcp"}）
  - policy（enum：direct｜block｜outbound_proxy）
  - outbound_tag（string，可空；当 policy=outbound_proxy 时使用）
  - enabled（bool，默认 true）
  - created_at（timestamp）
  - updated_at（timestamp）

- 表：rate_limits（限流策略，支持多用户或全局）
  - id（string，UUID）
  - scope_type（enum：global｜users）
  - user_ids（JSON，可空；当 scope_type=users 时为用户 ID 数组）
  - uplink_limit_bps（int，可空；上行带宽 bps）
  - downlink_limit_bps（int，可空；下行带宽 bps）
  - burst_bytes（int，可空；令牌桶突发）
  - enabled（bool，默认 true）
  - effective_from（timestamp，可空）
  - effective_to（timestamp，可空）
  - created_at（timestamp）
  - updated_at（timestamp）
  - 说明：
    - scope_type=global 时对所有用户生效；scope_type=users 时仅对 user_ids 所列用户生效。
    - 可同时存在多条策略；若存在冲突，由后端定义优先级（例如更具体的 users > global）。

### 2.2 后端接口设计（分页、详情、单条删除、修改；可附加创建）

- 通用分页参数
  - page（默认 1），page_size（默认 20，最大 200），q（可选，模糊搜索关键字），sort_by，sort_dir（asc/desc）。
  - 统一响应：{"items": [...], "total": 123, "page": 1, "page_size": 20}

- 用户 Users
  - GET /api/users：分页列表，支持按 username、auth_type、status 过滤/搜索
  - GET /api/users/{id}：详情
  - PUT /api/users/{id}：修改（username、status、remark、credential 重置等）
  - DELETE /api/users/{id}：单条删除（若被入站引用则按业务策略处理，见“业务校验”）
  - POST /api/users（可选）：创建

- 入站 Inbounds
  - GET /api/inbounds：分页列表，支持按 protocol、port、tls_enabled、status 过滤
  - GET /api/inbounds/{id}：详情
  - PUT /api/inbounds/{id}：修改（协议、端口、TLS、sniff、绑定用户、路由等）
  - DELETE /api/inbounds/{id}：单条删除
  - POST /api/inbounds（可选）：创建
  - GET /api/inbounds/options/users：为入站页面提供可选用户（下拉多选）
  - GET /api/inbounds/options/routes：为入站页面提供可选路由

- 路由 Routes
  - GET /api/routes：分页列表
  - GET /api/routes/{id}：详情
  - PUT /api/routes/{id}：修改（rules_json、policy、outbound_tag、enabled）
  - DELETE /api/routes/{id}：单条删除
  - POST /api/routes（可选）：创建

- 限流 Rate Limits（多用户或全局）
  - GET /api/rate-limits：分页列表，支持按 scope_type、enabled 过滤
  - GET /api/rate-limits/{id}：详情
  - GET /api/rate-limits/by-user/{user_id}：按用户查询（返回对该用户生效的策略：global + 包含该用户的 users）
  - PUT /api/rate-limits/{id}：修改（上下行、突发、启停、有效期、scope_type、user_ids）
  - DELETE /api/rate-limits/{id}：单条删除
  - POST /api/rate-limits（可选）：创建
  - GET /api/rate-limits/options/users：为限流页面提供用户下拉

- 统一错误码建议
  - 400 参数错误；403 无权限；404 资源不存在；409 业务冲突（如端口占用、被引用无法删除）；422 业务校验未通过；500 服务器错误。

### 2.3 前端界面与交互

- 页面划分
  - 代理协议配置界面（入站 Inbounds）
    - 列表：显示 name、protocol、port、tls、sniff、用户数量、路由名、状态、更新时间；支持分页/筛选。
    - 新建/编辑：
      - protocol：socks5｜https_connect｜socks5_https｜ss
      - 当选择 socks5_https 时：自动禁用 tls_enabled 并允许 sniff_enabled；
      - 当选择 ss 时：必须选择唯一一个用户（多选控件限制为 1），且端口不可与其他入站重复；
      - 选择路由（下拉，来自 routes）。
    - 详情：展示完整配置及引用用户、路由信息（弱引用展示）。
    - 操作：修改、单条删除。
    - 引用：需要引用用户与路由配置界面（联动选择）。

  - 用户配置界面（Users）
    - 列表：username、auth_type、status、remark、最近更新时间；支持分页和搜索。
    - 详情：基本信息；引用定位（例如“被哪些入站使用”由后端通过 allowed_user_ids 反查并展示）。
    - 操作：修改、单条删除（若被入站引用需阻止或提示处理）。
    - 创建（可选）：新增用户（socks_basic 或 ss）。

  - 路由配置界面（Routes）
    - 列表：name、policy、enabled、最近更新时间；支持分页。
    - 详情：以表单 + JSON Editor 展示 rules_json，支持导入/导出。
    - 操作：修改、单条删除。
    - 创建（可选）。

  - 限流配置界面（Rate Limits）
    - 列表：scope_type、user_ids（展示为用户名列表或“全局”）、上下行 bps、burst、enabled、有效期；支持分页/筛选。
    - 详情：查看与编辑；
    - 操作：修改、单条删除；
    - 创建（可选）；
    - 引用：会引用“用户配置界面”（多选用户）；支持“全局/指定用户”切换。

- 通用交互
  - 列表分页查询、详情查询、单条删除、修改操作为必备能力；创建为可选能力。
  - 删除前的“被引用检查”在后端完成，前端展示具体阻断原因。
  - 表单字段的业务校验采用前后端双重校验，后端为准。

### 2.4 关键业务校验与约束（无外键下的强一致性）

- 端口与协议
  - socks5_https：仅允许在 tls_enabled=false 时创建；同端口下只允许存在 1 条该 protocol 的入站记录。
  - ss：每个用户一个独立端口；该端口不可与任何其他入站记录冲突；allowed_user_ids 必须仅包含该用户 1 个 ID。
  - 启用 TLS 的入站只能选择单一协议（不为 socks5_https），避免嗅探歧义。

- 用户与引用
  - 删除用户：若该用户 ID 出现在任一 inbound_configs.allowed_user_ids 中，则返回 409 并附带引用列表，阻止删除。
  - 修改用户 auth_type：若从 ss 改为 socks_basic（或反之），需同时校验所有引用关系是否仍满足入站协议要求（例如 ss 入站必须绑定 ss 用户）。

- 路由与引用
  - 删除路由：若 route_id 被某入站引用，则返回 409 并附带引用列表，阻止删除。

- 限流策略
  - scope_type=users 时，user_ids 不可为空；
  - scope_type=global 可存在多条，但建议在业务层做优先级裁决（例如同维度冲突时选更新时间最近或权重更高者）。

- 唯一性与并发
  - 对 inbound_configs(listen_ip, port) 建立唯一索引（结合协议业务校验），避免端口冲突；
  - 对 users.username 建立唯一索引；
  - 所有关联均为弱引用字符串或 JSON ID 列表，依赖应用层在写操作时做一致性校验。

### 2.5 配置聚合与下发（无版本回滚）

- 聚合规则
  - 控制面在发布时，将 enabled 的 inbounds、users、routes、rate_limits 汇总为一份运行配置（JSON）。
  - 对于 socks5_https：在同一监听端口生成具备协议嗅探的入站；对于 TLS 入站：仅生成单协议入站。
  - 对于 ss 入站：按“每用户一端口”逐条生成；绑定的用户凭据取自 users.credential，算法取自 inbound_configs.ss_method。
  - 限流：
    - global：生成全局限流策略；
    - users：为 user_ids 中的每个用户生成限流条目。

- 下发与生效
  - 采用“覆盖式发布”，不维护历史版本，不提供回滚；
  - 发布前做全量校验（端口冲突、引用完整性、协议/用户匹配、限流范围合法性）；失败则拒绝发布并返回明细。

- 观测与审计（可选，非必需）
  - 可追加运行时指标与操作审计，但本次设计不做强制要求。

### 2.6 协议配置查询数据 JSON 详情（入站 Inbounds）

- 列表响应（GET /api/inbounds）示例：
  - {
    "items": [
      {
        "id": "inb_1",
        "name": "Public SOCKS/HTTPS",
        "protocol": "socks5_https",
        "listen_ip": "0.0.0.0",
        "port": 1080,
        "tls_enabled": false,
        "sniff_enabled": true,
        "allowed_user_ids": ["u1", "u2"],
        "user_count": 2,
        "route_id": "r1",
        "route_name": "default",
        "status": "enabled",
        "updated_at": "2025-09-01T12:00:00Z"
      }
    ],
    "total": 1,
    "page": 1,
    "page_size": 20
  }
- 详情响应（GET /api/inbounds/{id}）示例：
  - {
    "id": "inb_1",
    "name": "Public SOCKS/HTTPS",
    "protocol": "socks5_https",
    "listen_ip": "0.0.0.0",
    "port": 1080,
    "tls_enabled": false,
    "sniff_enabled": true,
    "allowed_user_ids": ["u1", "u2"],
    "allowed_users_resolved": [
      {"id": "u1", "username": "alice", "auth_type": "socks_basic"},
      {"id": "u2", "username": "bob", "auth_type": "ss"}
    ],
    "route": {"id": "r1", "name": "default"},
    "status": "enabled",
    "created_at": "2025-08-30T10:00:00Z",
    "updated_at": "2025-09-01T12:00:00Z"
  }

### 2.7 数据库表创建语句（MySQL 8）

- users

```sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  username VARCHAR(255) NOT NULL UNIQUE,
  credential VARCHAR(255) NULL,
  status ENUM('enabled','disabled') NOT NULL DEFAULT 'enabled',
  remark VARCHAR(255) NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

- inbound_configs

```sql
CREATE TABLE inbound_configs (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  protocol ENUM('socks5','https_connect','socks5_https','ss') NOT NULL,
  listen_ip VARCHAR(45) NOT NULL DEFAULT '0.0.0.0',
  port INT NOT NULL,
  tls_enabled TINYINT(1) NOT NULL DEFAULT 0,
  sniff_enabled TINYINT(1) NOT NULL DEFAULT 0,
  ss_method VARCHAR(64) NULL,
  allowed_user_ids JSON NULL,
  route_id VARCHAR(36) NULL,
  status ENUM('enabled','disabled') NOT NULL DEFAULT 'enabled',
  notes VARCHAR(255) NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_inbound_listen (listen_ip, port),
  KEY idx_inbound_protocol (protocol),
  KEY idx_inbound_status (status)
);
```

- routes

```sql
CREATE TABLE routes (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  rules_json JSON NOT NULL,
  policy ENUM('direct','block','outbound_proxy') NOT NULL,
  outbound_tag VARCHAR(64) NULL,
  enabled TINYINT(1) NOT NULL DEFAULT 1,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY idx_routes_enabled (enabled)
);
```

- rate_limits

```sql
CREATE TABLE rate_limits (
  id VARCHAR(36) PRIMARY KEY,
  scope_type ENUM('global','users') NOT NULL,
  user_ids JSON NULL,
  uplink_limit_bps INT NULL,
  downlink_limit_bps INT NULL,
  burst_bytes INT NULL,
  enabled TINYINT(1) NOT NULL DEFAULT 1,
  effective_from DATETIME NULL,
  effective_to DATETIME NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY idx_rl_enabled (enabled),
  KEY idx_rl_scope (scope_type)
);
```

### 2.8 配置分发机制（管理端 -> 代理）

目标：在管理端配置变更后，可靠、及时、幂等地让代理进程获取并生效。

方案对比：
- A. 代理轮询（短轮询/长轮询）
  - 优点：实现简单、对 NAT 友好；无需在代理侧暴露端口。
  - 缺点：短轮询存在延迟；长轮询需要维护挂起连接。
  - 建议实现：
    - GET /api/configs/version 返回最新 version 与 checksum（ETag）。
    - 若本地 version 不同，则 GET /api/configs/{version} 拉取完整快照；应用成功后 POST /api/agents/{id}/ack {version, ok, message?}。
    - 利用 ETag/If-None-Match 降低带宽；失败重试采用指数退避，确保幂等。
- B. 管理端主动推送（两种落地）
  - 反向长连接（推荐的“推送”形态）：由代理主动拨出 WebSocket/gRPC 流到管理端，管理端在该通道上实时推送配置与指令；穿透 NAT，实时性好。
  - 直连回调（不推荐）：管理端直连代理监听端口调用 HTTP/gRPC 回调；对 NAT/安全要求高，运维复杂。
  - 优点：实时、可复用通道做心跳/命令；缺点：连接管理与实现复杂度较高。

推荐结论：
- 首选“长轮询/SSE”，实现简单、部署成本低；在网络或依赖受限环境下易落地。
- 如需更高实时性与命令通道复用，可升级为“代理发起的长连接订阅（WebSocket 或 gRPC stream）”。

接口建议与时序：
1) 注册：POST /api/agents/register → 返回 agent_id、心跳/订阅地址与签名 token。
2) 订阅：
   - WebSocket：ws[s]:///api/agents/{id}/subscribe?since=ver
   - gRPC：SubscribeConfig(stream) → 服务端按需推送 ConfigSnapshot
   - SSE：GET /api/agents/{id}/events?since=ver 返回 text/event-stream；事件类型：config/heartbeat/command
   - 长轮询：GET /api/agents/{id}/subscribe?since=ver（无新版本时挂起 ≤30s，超时 204）
3) 下发：返回完整快照 {version, checksum, data...}；代理应用成功后 POST /api/agents/{id}/ack。
4) 心跳：POST /api/agents/{id}/heartbeat {version, caps, metrics?}（可选）。
5) 可靠性：
   - 版本号单调递增 + checksum 保证顺序与完整性；相同版本幂等。
   - 失败不更新运行态；重试采用指数退避；管理端可标记强制重拉。
   - 安全：双向 TLS 或 Token 鉴权；IP 白名单与限流。

2.9 表关系图（简化）

为保证 Typora 兼容，以下使用 ASCII 简图与文字说明（弱引用均为字符串/JSON ID）：

```
+----------------+           allowed_user_ids (JSON, weak)     +--------------------+
|     users      |<--------------------------------------------|  inbound_configs   |
| id (PK)        |                                             | id (PK)            |
| username (UQ)  |                                             | route_id (string) -+----> routes.id (weak)
+----------------+                                             +--------------------+
           ^                                                            
           | user_ids (JSON, weak)                                      
+--------------------+                                                  
|    rate_limits     |                                                  
| scope_type=users   |                                                  
+--------------------+                                                  

注：
- inbound_configs.allowed_user_ids 为用户 ID 列表（JSON），当 protocol=ss 时长度必须为 1。
- inbound_configs.route_id 为弱引用 routes.id。
- rate_limits.scope_type=global 时对所有用户生效；=users 时仅对 user_ids 列举的用户生效。
```

## 三、数据示例

- inbound_configs 示例（socks5_https 非 TLS 同端口嗅探）：
  - {"protocol":"socks5_https","listen_ip":"0.0.0.0","port":1080,"tls_enabled":false,"sniff_enabled":true,"allowed_user_ids":["u_1","u_2"],"route_id":"r_1"}
- inbound_configs 示例（ss，每用户独立端口）：
  - {"protocol":"ss","listen_ip":"0.0.0.0","port":7001,"tls_enabled":false,"ss_method":"aes-256-gcm","allowed_user_ids":["u_ss_1"]}
- rate_limits 示例：
  - {"scope_type":"global","uplink_limit_bps":1048576,"downlink_limit_bps":2097152,"burst_bytes":262144,"enabled":true}
  - {"scope_type":"users","user_ids":["u_ss_1","u_2"],"uplink_limit_bps":524288,"downlink_limit_bps":1048576,"enabled":true}



